

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-59249373-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Message Passing &mdash; Epiphany BSP 1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Communicating with the Epiphany" href="host_client.html" />
    <link rel="prev" title="BSP Variables" href="variables.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Epiphany BSP
          

          
            
            <img src="_static/coduin_logo_small.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction and Setting up</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html">Getting started: The Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="variables.html">BSP Variables</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Message Passing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#sending-and-receiving-messages">Sending and receiving messages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#interface-messages">Interface (Messages)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#epiphany">Epiphany</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="host_client.html">Communicating with the Epiphany</a></li>
<li class="toctree-l1"><a class="reference internal" href="streaming.html">Data streams</a></li>
<li class="toctree-l1"><a class="reference internal" href="other_features.html">Other features</a></li>
</ul>
<p class="caption"><span class="caption-text">Support Library</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="memory_management.html">Memory Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference &amp; Background</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="memory_details.html">Parallella Memory Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="bsp.html">BSP Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_reference.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Epiphany BSP</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Message Passing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/mp.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="message-passing">
<h1>Message Passing<a class="headerlink" href="#message-passing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="sending-and-receiving-messages">
<h2>Sending and receiving messages<a class="headerlink" href="#sending-and-receiving-messages" title="Permalink to this headline">¶</a></h2>
<p>The next subject we will discuss is <em>passing messages</em> between Epiphany cores. Message passing provides a way to communicate between cores, without having to register variables. This relies on a <em>message queue</em>, which is available to every processor. Using message passing, you can communicate to other cores without registering variables. This can be very useful when the amount of data varies from core to core, and it is not clear beforehand how the data will be distributed. It is good to keep in mind that message passing is a lot slower than alternative communication methods since it utilizes the <em>external memory</em>.</p>
<p>A BSP message has a <em>tag</em> and a <em>payload</em>. The <em>tag</em> identifies the message, and the <em>payload</em> contains the acutal data. The size (in bytes) of a tag is universal, i.e. it is the same across all Epiphany cores (as well as the host). The tagsize can be set using <code class="docutils literal notranslate"><span class="pre">bsp_set_tagsize</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">tagsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="n">bsp_set_tagsize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tagsize</span><span class="p">);</span>
<span class="n">bsp_sync</span><span class="p">();</span>
</pre></div>
</div>
<p>The tagsize must be set on each core simultaneously, that is to say in the same <em>superstep</em>. Alternatively, The tagsize can also be set on the host before issuing <code class="docutils literal notranslate"><span class="pre">ebsp_spmd</span></code>. For compatibility reasons, the call to <code class="docutils literal notranslate"><span class="pre">bsp_set_tagsize</span></code> writes the old value for the tagsize to its argument. We also provide an alternative way to obtain the tagsize, by simply calling <code class="docutils literal notranslate"><span class="pre">ebsp_get_tagsize</span></code>.:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">tagsize</span> <span class="o">=</span> <span class="n">ebsp_get_tagsize</span><span class="p">();</span>
</pre></div>
</div>
<p>After setting the tagsize (and synchronizing), we are ready to start sending messages. We can send a message using <code class="docutils literal notranslate"><span class="pre">bsp_send</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">payload</span> <span class="o">=</span> <span class="mi">42</span> <span class="o">+</span> <span class="n">s</span><span class="p">;</span>
<span class="n">bsp_send</span><span class="p">((</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="n">bsp_sync</span><span class="p">();</span>
</pre></div>
</div>
<p>We first need to declare variables holding the tag and the payload. In our case these are integers, but in general you can use any data type. In order, the arguments of <code class="docutils literal notranslate"><span class="pre">bsp_send</span></code> are:</p>
<ol class="arabic simple">
<li>The <code class="docutils literal notranslate"><span class="pre">pid</span></code> of processor we want to <em>send</em> the message to.</li>
<li>A pointer to the tag data.</li>
<li>A pointer to the payload data.</li>
<li>The size of the payload. Note that you can vary this size between every send call, contrary to the tagsize.</li>
</ol>
<p>After synchronizing, the target processor can receive the message. To receive messages, we must first inspect the queue:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">accum_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bsp_qsize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packets</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">accum_bytes</span><span class="p">);</span>
</pre></div>
</div>
<p>The call to <code class="docutils literal notranslate"><span class="pre">bsp_qsize</span></code> writes the <em>number of packets</em> to the first argument, and the <em>total number of bytes in the queue</em> to the second argument. Next, we can loop over each packet, <em>moving</em> the packages to the local core:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">payload_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">payload_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">tag_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">packets</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">bsp_get_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag_in</span><span class="p">);</span>
    <span class="n">bsp_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload_in</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="n">ebsp_message</span><span class="p">(</span><span class="s">&quot;payload: %i, tag: %i&quot;</span><span class="p">,</span> <span class="n">payload_in</span><span class="p">,</span> <span class="n">tag_in</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We use two new primitives here. First we obtain for each packet (note that here we only have a single packet) the payload size and the incoming tag, using <code class="docutils literal notranslate"><span class="pre">bsp_get_tagsize</span></code>. The payload itself is <em>moved</em> using <code class="docutils literal notranslate"><span class="pre">bsp_move</span></code>. The first argument should point to a buffer large enough to store the payload data, and the second argument is the number of bytes to move. Note that we could use our obtained payload size to allocate a buffer large enough to hold the payload, and we could pass it to the second argument of <code class="docutils literal notranslate"><span class="pre">bsp_move</span></code>. It is good to keep in mind that if less bytes are moved than the size of the payload, the remaining data is thrown away. Here we know all messages contain a single integer, such that we can just write the payload into a local variable directly.</p>
<p>This code results in the following output:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>$02: payload: 43, tag: 1
$08: payload: 49, tag: 1
$00: payload: 57, tag: 1
$13: payload: 54, tag: 1
...
</pre></div>
</div>
<p>Message passing is a very general and powerful technique when using variables to communicate proves to restrictive. However, the flexibility of message passing comes with performance penalty, because the buffers that are involved are too large to store on a single core. As before, <code class="docutils literal notranslate"><span class="pre">bsp_hpput</span></code> and <code class="docutils literal notranslate"><span class="pre">bsp_hpget</span></code> should be your preferred way of communicating if you are optimizing for speed.</p>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>We finish our discussion of inter-core BSP message passing by providing a complete program that sends messages around:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bsp_pid</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="n">bsp_nprocs</span><span class="p">();</span>

<span class="kt">int</span> <span class="n">tagsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="n">bsp_set_tagsize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tagsize</span><span class="p">);</span>
<span class="n">bsp_sync</span><span class="p">();</span>

<span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">payload</span> <span class="o">=</span> <span class="mi">42</span> <span class="o">+</span> <span class="n">s</span><span class="p">;</span>
<span class="n">bsp_send</span><span class="p">((</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="n">bsp_sync</span><span class="p">();</span>

<span class="kt">int</span> <span class="n">packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">accum_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">bsp_qsize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packets</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">accum_bytes</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">payload_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">payload_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">tag_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">packets</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">bsp_get_tag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag_in</span><span class="p">);</span>
    <span class="n">bsp_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload_in</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
    <span class="n">ebsp_message</span><span class="p">(</span><span class="s">&quot;payload: %i, tag: %i&quot;</span><span class="p">,</span> <span class="n">payload_in</span><span class="p">,</span> <span class="n">tag_in</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="interface-messages">
<h2>Interface (Messages)<a class="headerlink" href="#interface-messages" title="Permalink to this headline">¶</a></h2>
<div class="section" id="epiphany">
<h3>Epiphany<a class="headerlink" href="#epiphany" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">doxygenfunction: Cannot find file: /export/scratch1/buurlage/code/parallel/epiphany-bsp/docs/xml_e/index.xml</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">doxygenfunction: Cannot find file: /export/scratch1/buurlage/code/parallel/epiphany-bsp/docs/xml_e/index.xml</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">doxygenfunction: Cannot find file: /export/scratch1/buurlage/code/parallel/epiphany-bsp/docs/xml_e/index.xml</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">doxygenfunction: Cannot find file: /export/scratch1/buurlage/code/parallel/epiphany-bsp/docs/xml_e/index.xml</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">doxygenfunction: Cannot find file: /export/scratch1/buurlage/code/parallel/epiphany-bsp/docs/xml_e/index.xml</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">doxygenfunction: Cannot find file: /export/scratch1/buurlage/code/parallel/epiphany-bsp/docs/xml_e/index.xml</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">doxygenfunction: Cannot find file: /export/scratch1/buurlage/code/parallel/epiphany-bsp/docs/xml_e/index.xml</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="host_client.html" class="btn btn-neutral float-right" title="Communicating with the Epiphany" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="variables.html" class="btn btn-neutral" title="BSP Variables" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-2017, Coduin.
      Last updated on Jun 15, 2018.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>